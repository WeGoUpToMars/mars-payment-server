<!DOCTYPE html>
<html lang="ko">
<head>
  <title>구매하기</title>
  <meta charset="utf-8"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
  <script src="http://code.jquery.com/jquery-latest.min.js"></script>
</head>
<body>
<section>
  <h1>구매하기</h1>
  <h3>티셔츠</h3>
  <span id="price">10</span>원
  <br>
  <button id="toss-payment-button">TOSS PAY로 결제하기</button>
  <br>
  <button id="kakao-payment-button">KAKAO PAY로 결제하기</button>
</section>
<script src="https://js.tosspayments.com/v1"></script>
<script>
  const orderId = new Date().getTime();
  const price = parseInt(document.getElementById("price").textContent);

  tossPay(orderId, price);
  kakaoPay(orderId, price);

  function tossPay(orderId, price) {
    const tossPayments = TossPayments("test_ck_ADpexMgkW36GJ10RlzdVGbR5ozO0");

    const tossPayButton = document.getElementById("toss-payment-button");
    tossPayButton.addEventListener("click", function () {
      const paymentData = {
        amount: price,
        orderId: orderId,
        orderName: "티셔츠",
        customerName: "이토페",
        successUrl: window.location.origin + "/mars/payments/toss/success",
        failUrl: window.location.origin + "/mars/payments/toss/fail",
      };

      tossPayments.requestPayment("카드", paymentData);
    });

  }

  function kakaoPay(orderId, price) {

    const prepareRequest = {
      "cid": "TC0ONETIME",
      "partner_order_id": orderId,
      "partner_user_id": "user-01",
      "item_name": "책",
      "quantity": 1,
      "total_amount": price,
      "tax_free_amount": price,
      "approval_url": window.location.origin + "/mars/payments/kakao/success",
      "cancel_url": window.location.origin + "/mars/payments/kakao/cancel",
      "fail_url": window.location.origin + "/mars/payments/kakao/fail"
    };

    $('#kakao-payment-button').click(
            function () {
              $.ajax({
                url: "http://localhost:18189/mars/payments/kakao/prepare",
                method: "post",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(prepareRequest),
                success: function (response) {
                  const kakaoResponse = {
                    "tid": response.tid,
                    "next_redirect_app_url": response.next_redirect_app_url,
                    "next_redirect_mobile_url": response.next_redirect_mobile_url,
                    "next_redirect_pc_url": response.next_redirect_pc_url,
                    "android_app_scheme": response.android_app_scheme,
                    "ios_app_scheme": response.ios_app_scheme,
                    "created_at": response.create
                  }

                  console.log(kakaoResponse);

                  if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    window.location.href = kakaoResponse.next_redirect_mobile_url;
                  } else {
                    window.location.href = kakaoResponse.next_redirect_pc_url;
                  }
                },
                error: function (error) {
                  console.log(error);
                  alert("error!");
                }
              });
            }
    );
  }
</script>
</body>
</html>
